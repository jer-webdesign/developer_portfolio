name: Security Audit

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Enables manual trigger from GitHub Actions UI

jobs:
  npm-audit:
    name: npm audit (backend & frontend)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dir: [backend, frontend]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./${{ matrix.dir }}
        run: npm ci

      - name: Run npm audit and save JSON
        working-directory: ./${{ matrix.dir }}
        continue-on-error: true
        run: npm audit --json > audit-result.json

      - name: Create summary script
        working-directory: ./${{ matrix.dir }}
        run: |
          cat > summarize.js << 'EOF'
          const fs = require('fs');
          
          const auditFile = 'audit-result.json';
          const summaryFile = 'audit-summary.txt';
          
          if (!fs.existsSync(auditFile)) {
            console.log('No audit report found');
            fs.writeFileSync(summaryFile, 'No audit report');
            process.exit(0);
          }
          
          try {
            const audit = JSON.parse(fs.readFileSync(auditFile, 'utf8'));
            const vulnerabilities = audit.metadata?.vulnerabilities || {};
            const total = Object.values(vulnerabilities).reduce((sum, count) => sum + count, 0);
            const bySeverity = Object.entries(vulnerabilities)
              .map(([severity, count]) => severity + ': ' + count)
              .join(', ');
            
            const output = 'Directory: ' + process.env.AUDIT_DIR + '\n' +
                          'Total Vulnerabilities: ' + total + '\n' +
                          'By Severity: ' + (bySeverity || 'none') + '\n';
            
            console.log(output);
            fs.writeFileSync(summaryFile, output);
          } catch (error) {
            console.error('Error parsing audit:', error.message);
            fs.writeFileSync(summaryFile, 'Parse error: ' + error.message);
          }
          EOF

      - name: Summarize audit results
        working-directory: ./${{ matrix.dir }}
        env:
          AUDIT_DIR: ${{ matrix.dir }}
        run: node summarize.js

      - name: Upload audit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: audit-${{ matrix.dir }}
          path: |
            ${{ matrix.dir }}/audit-result.json
            ${{ matrix.dir }}/audit-summary.txt
